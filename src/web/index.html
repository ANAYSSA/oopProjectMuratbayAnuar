<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ANUAR CINEMA - Professional Portal</title>
    <style>
        :root { --primary: #ff6d00; --dark: #1a1a1a; --danger: #d32f2f; --success: #388e3c; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; margin: auto; }
        .main-content { max-width: 1200px; width: 100%; display: none; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        .admin-panel { background: #fff8e1; border: 2px solid #ffe082; padding: 20px; border-radius: 10px; margin-bottom: 25px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; width: 100%; }
        .btn-add { background: var(--success); color: white; }
        .btn-upd { background: #0288d1; color: white; }
        .btn-del { background: var(--danger); color: white; }
        
        .search-bar { width: 100%; padding: 15px; font-size: 18px; border: 2px solid var(--primary); border-radius: 10px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--dark); color: white; position: sticky; top: 0; }
        tr:hover { background: #f9f9f9; }
        .badge { padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; color: white; }
    </style>
</head>
<body>

    <div id="loginScreen" class="card">
        <h2 style="text-align:center">CINEMA LOGIN</h2>
        <input type="text" id="loginUser" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button style="background:var(--primary); color:white" onclick="login()">–í–æ–π—Ç–∏</button>
        <p style="text-align:center">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="showScreen('regScreen')">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
    </div>

    <div id="regScreen" class="card" style="display: none;">
        <h2 style="text-align:center">REGISTRATION</h2>
        <input type="text" id="regUser" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" id="regPass" placeholder="–ü–∞—Ä–æ–ª—å">
        <input type="text" id="regName" placeholder="–§–ò–û">
        <input type="number" id="regBalance" placeholder="–ë–∞–ª–∞–Ω—Å ‚Ç∏">
        <button style="background:var(--primary); color:white" onclick="register()">–°–æ–∑–¥–∞—Ç—å</button>
        <button style="background:none; color:var(--primary); border:1px solid var(--primary); margin-top:10px" onclick="showScreen('loginScreen')">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="contentScreen" class="main-content">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <h1>ANUAR <span id="userBadge" class="badge"></span></h1>
            <button style="width:auto; background:#666; color:white" onclick="location.reload()">–í—ã—Ö–æ–¥</button>
        </div>

        <div id="adminPanel" class="admin-panel" style="display:none">
            <h3 style="margin-top:0">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (Admin)</h3>
            <div class="grid-3">
                <div>
                    <p><b>‚ûï –ù–æ–≤—ã–π —Ñ–∏–ª—å–º</b></p>
                    <input type="text" id="addTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                    <input type="number" id="addPrice" placeholder="–¶–µ–Ω–∞ ‚Ç∏">
                    <select id="addGenre">
                        <option value="ACTION">Action</option><option value="COMEDY">Comedy</option>
                        <option value="DRAMA">Drama</option><option value="HORROR">Horror</option>
                        <option value="FANTASY">Fantasy</option><option value="ANIMATION">Animation</option>
                        <option value="THRILLER">Thriller</option><option value="ROMANCE">Romance</option>
                    </select>
                    <button class="btn-add" onclick="addFilm()">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
                <div>
                    <p><b>üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É</b></p>
                    <select id="updFilmList"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º...</option></select>
                    <input type="number" id="updPrice" placeholder="–ù–æ–≤–∞—è —Ü–µ–Ω–∞ ‚Ç∏">
                    <button class="btn-upd" onclick="updatePrice()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
                <div>
                    <p><b>üóë –£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º</b></p>
                    <select id="delFilmList"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º...</option></select>
                    <button class="btn-del" onclick="deleteFilmManual()">–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞</button>
                </div>
            </div>
        </div>

        <input type="text" id="search" class="search-bar" placeholder="üîç –ü–æ–∏—Å–∫ —Ñ–∏–ª—å–º–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." onkeyup="filterFilms()">

        <table>
            <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞</th><th>–ñ–∞–Ω—Ä</th><th id="actionHead" style="display:none">–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
            <tbody id="filmTableBody"></tbody>
        </table>
    </div>

    <script>
        let allFilms = [];
        let currentRole = '';

        function showScreen(id) {
            ['loginScreen', 'regScreen', 'contentScreen'].forEach(s => document.getElementById(s).style.display = 'none');
            document.getElementById(id).style.display = (id === 'contentScreen' ? 'block' : 'block');
        }

        async function login() {
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;
            const res = await fetch('/api/login', { method: 'POST', body: `user=${user}&pass=${pass}` });
            const data = await res.json();

            if(data.success) {
                currentRole = data.role;
                const b = document.getElementById('userBadge');
                b.innerText = data.role;
                b.style.background = (data.role === 'ADMIN' ? 'var(--danger)' : 'var(--success)');
                if(data.role === 'ADMIN') {
                    document.getElementById('adminPanel').style.display = 'block';
                    document.getElementById('actionHead').style.display = 'table-cell';
                }
                showScreen('contentScreen');
                loadFilms();
            } else alert("‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.");
        }

        async function loadFilms() {
            try {
                const res = await fetch('/api/films');
                allFilms = await res.json();
                renderTable(allFilms);
                updateDropdowns();
            } catch (e) {
                console.error(e);
                alert("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∏–ª—å–º–æ–≤.");
            }
        }

        function renderTable(films) {
            const tbody = document.getElementById('filmTableBody');
            if (films.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">–§–∏–ª—å–º–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>';
                return;
            }
            tbody.innerHTML = films.map(f => `
                <tr>
                    <td><b>${f.title}</b></td>
                    <td>${f.price} ‚Ç∏</td>
                    <td><span class="badge" style="background:#555">Active</span></td>
                    ${currentRole === 'ADMIN' ? `<td><button class="btn-del" style="padding:5px" onclick="deleteFilmDirect('${f.title}')">üóë</button></td>` : ''}
                </tr>
            `).join('');
        }

        function updateDropdowns() {
            const upd = document.getElementById('updFilmList');
            const del = document.getElementById('delFilmList');
            const options = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º...</option>' + 
                            allFilms.map(f => `<option value="${f.title}">${f.title}</option>`).join('');
            upd.innerHTML = options;
            del.innerHTML = options;
        }

        function filterFilms() {
            const text = document.getElementById('search').value.toLowerCase();
            const filtered = allFilms.filter(f => f.title.toLowerCase().includes(text));
            renderTable(filtered);
        }

        async function addFilm() {
            const t = document.getElementById('addTitle').value;
            const p = document.getElementById('addPrice').value;
            const g = document.getElementById('addGenre').value;
            if(!t || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");

            const res = await fetch('/api/films', { method: 'POST', body: `title=${t}&price=${p}&genre=${g}` });
            if(res.ok) { alert("‚úÖ –§–∏–ª—å–º '" + t + "' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!"); loadFilms(); }
        }

        async function updatePrice() {
            const t = document.getElementById('updFilmList').value;
            const p = document.getElementById('updPrice').value;
            if(!t || !p) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º –∏ —É–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É!");

            const res = await fetch('/api/films', { method: 'PUT', body: `title=${t}&price=${p}` });
            if(res.ok) { alert("üîÑ –¶–µ–Ω–∞ –¥–ª—è '" + t + "' –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ " + p + " ‚Ç∏"); loadFilms(); }
        }

        async function deleteFilmManual() {
            const t = document.getElementById('delFilmList').value;
            if(!t) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è!");
            if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º '" + t + "'?")) {
                const res = await fetch(`/api/films?title=${t}`, { method: 'DELETE' });
                if(res.ok) { alert("üóë –§–∏–ª—å–º '" + t + "' —É–¥–∞–ª–µ–Ω –∏–∑ –±–∞–∑—ã."); loadFilms(); }
            }
        }

        async function deleteFilmDirect(title) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å '" + title + "'?")) {
                const res = await fetch(`/api/films?title=${title}`, { method: 'DELETE' });
                if(res.ok) { alert("üóë –£–¥–∞–ª–µ–Ω–æ."); loadFilms(); }
            }
        }

        async function register() {
            const u = document.getElementById('regUser').value;
            const p = document.getElementById('regPass').value;
            const n = document.getElementById('regName').value;
            const b = document.getElementById('regBalance').value;
            const res = await fetch('/api/register', { method: 'POST', body: `user=${u}&pass=${p}&name=${n}&balance=${b}` });
            if(res.ok) { alert("üéâ –ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ."); showScreen('loginScreen'); }
        }
    </script>
</body>
</html>